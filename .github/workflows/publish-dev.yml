name: Publish Dev Package

on:
  push:
    branches: [dev]

jobs:
  publish-dev:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6
      
      - uses: actions/setup-node@v6
        with:
          node-version: '22'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@chicago-film-supplies'
          cache: 'npm'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - run: npm update @chicago-film-supplies/date-helpers
      - run: npm ci
      
      # Generate prerelease version: 1.2.0 â†’ 1.2.0-dev.{run_number}.{short_sha}
      - name: Set prerelease version
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          BASE_VERSION=$(node -p "require('./package.json').version")
          # Strip any existing prerelease suffix to get base
          BASE_VERSION=$(echo $BASE_VERSION | sed 's/-.*//')
          DEV_VERSION="${BASE_VERSION}-dev.${GITHUB_RUN_NUMBER}.${SHORT_SHA}"
          npm version $DEV_VERSION --no-git-tag-version
          echo "Publishing version: $DEV_VERSION"
      
      - run: npm publish --tag dev

  dispatch:
    needs: build
    strategy:
      matrix:
        repo: ['chicago-film-supplies/api/functions', 'chicago-film-supplies/manager']
    runs-on: ubuntu-latest
    steps:
      - name: Trigger dependent repos
        uses: peter-evans/repository-dispatch@v4.0.1
        with:
          token: ${{ secrets.REPO_DISPATCH_PAT }}  # PAT with repo scope
          repository: ${{ matrix.repo }}
          event-type: package-updated
          client-payload: '{"package": "@chicago-film-supplies/date-helpers", "version": "${{ env.DEV_VERSION }}"}'